name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm install

      - name: Extract Version and Time
        id: vars
        run: |
          # 获取版本号 (去掉 v)
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          
          # 获取发布时间 (用于通知显示)
          RELEASE_TIME=$(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M')
          echo "RELEASE_TIME=$RELEASE_TIME" >> $GITHUB_OUTPUT
          
          # 获取发布时间 (用于文件名，不允许有空格)
          FILE_TIME=$(TZ='Asia/Shanghai' date +'%Y-%m-%d-%H-%M')
          echo "FILE_TIME=$FILE_TIME" >> $GITHUB_OUTPUT

      - name: Build and Package
        run: |
          VERSION=${{ steps.vars.outputs.VERSION }}
          FILE_TIME=${{ steps.vars.outputs.FILE_TIME }}
          
          # 1. 构建二进制文件
          npx pkg . --targets node18-win-x64,node18-linux-x64,node18-macos-x64 --out-path dist
          
          # 2. 准备发布目录
          mkdir -p pkg/win pkg/linux pkg/macos
          
          # 3. 复制文件并重命名为要求格式：项目名称_系统_版本_时间
          cp dist/exam-system-win.exe "pkg/win/exam-system_windows-x64_v$VERSION_$FILE_TIME.exe"
          cp dist/exam-system-linux "pkg/linux/exam-system_linux-x64_v$VERSION_$FILE_TIME"
          cp dist/exam-system-macos "pkg/macos/exam-system_macos-x64_v$VERSION_$FILE_TIME"
          
          # 4. 复制 .env.example 到每个包
          cp .env.example pkg/win/
          cp .env.example pkg/linux/
          cp .env.example pkg/macos/
          
          # 5. 压缩打包
          cd pkg/win && zip -r "../../exam-system_windows-x64_v$VERSION_$FILE_TIME.zip" . && cd ../..
          cd pkg/linux && tar -czvf "../../exam-system_linux-x64_v$VERSION_$FILE_TIME.tar.gz" . && cd ../..
          cd pkg/macos && tar -czvf "../../exam-system_macos-x64_v$VERSION_$FILE_TIME.tar.gz" . && cd ../..

      - name: Extract Changelog Summary
        id: extract_changelog
        run: |
          VERSION=${{ steps.vars.outputs.VERSION }}
          echo "Extracting changelog for version $VERSION"
          
          # 提取当前版本的更新日志全文 (用于 GitHub Release)
          awk -v ver="[$VERSION]" '/^## / { if (p) { exit }; if ($0 ~ ver) { p=1; next } } p' CHANGELOG.md > RELEASE_NOTES.md
          
          # 提取三级标题作为摘要 (用于飞书通知)
          SUMMARY=$(awk -v ver="[$VERSION]" '/^## / { if (p) { exit }; if ($0 ~ ver) { p=1; next } } p && /^### / { print "▫️ " substr($0, 5) }' CHANGELOG.md)
          
          # 设置多行输出变量
          echo "SUMMARY<<EOF" >> $GITHUB_OUTPUT
          echo "$SUMMARY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          body_path: RELEASE_NOTES.md
          files: |
            exam-system-*.zip
            exam-system-*.tar.gz
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: 通知飞书群
        env:
          WEBHOOK_URL: ${{ secrets.FEISHU_WEBHOOK }}
          SECRET: ${{ secrets.FEISHU_SECRET }}
          VERSION: ${{ steps.vars.outputs.VERSION }}
          SUMMARY: ${{ steps.extract_changelog.outputs.SUMMARY }}
          RELEASE_TIME: ${{ steps.vars.outputs.RELEASE_TIME }}
        run: |
          python3 - <<EOF
          import hmac
          import hashlib
          import base64
          import time
          import json
          import urllib.request
          import os
          import sys

          def gen_sign(secret, timestamp):
              string_to_sign = '{}\n{}'.format(timestamp, secret)
              hmac_code = hmac.new(string_to_sign.encode("utf-8"), digestmod=hashlib.sha256).digest()
              sign = base64.b64encode(hmac_code).decode('utf-8')
              return sign

          def send():
              url = os.environ.get('WEBHOOK_URL')
              secret = os.environ.get('SECRET')
              version = os.environ.get('VERSION')
              summary = os.environ.get('SUMMARY', '')
              release_time = os.environ.get('RELEASE_TIME', '')
              repo = os.environ.get('GITHUB_REPOSITORY')
              
              if not url or not secret:
                  print("Error: Missing WEBHOOK_URL or SECRET")
                  sys.exit(1)
              
              timestamp = str(int(time.time()))
              sign = gen_sign(secret, timestamp)
              
              # 构建精美的飞书消息卡片
              payload = {
                  "timestamp": timestamp,
                  "sign": sign,
                  "msg_type": "interactive",
                  "card": {
                      "header": {
                          "title": {
                              "tag": "plain_text",
                              "content": "考试系统版本更新通知"
                          },
                          "template": "blue"
                      },
                      "elements": [
                          {
                              "tag": "div",
                              "text": {
                                  "tag": "lark_md",
                                  "content": f"**发布时间**: {release_time}\n**版本**: v{version}\n**更新内容摘要**:\n{summary}"
                              }
                          },
                          {
                              "tag": "hr"
                          },
                          {
                              "tag": "action",
                              "actions": [
                                  {
                                      "tag": "button",
                                      "text": {
                                          "tag": "plain_text",
                                          "content": "查看完整日志"
                                      },
                                      "type": "primary",
                                      "url": f"https://github.com/{repo}/releases/tag/v{version}"
                                  }
                              ]
                          }
                      ]
                  }
              }
              
              req = urllib.request.Request(url, data=json.dumps(payload).encode('utf-8'), headers={'Content-Type': 'application/json'})
              try:
                  with urllib.request.urlopen(req) as f:
                      res = f.read().decode('utf-8')
                      print(f"Response: {res}")
              except Exception as e:
                  print(f"Error sending message: {e}")
                  sys.exit(1)

          if __name__ == "__main__":
              send()
          EOF
