# 更新日志 (Changelog)

## [1.3.0] - 2026-01-24

### 🛡️ 深度安全加固 (Security Hardening)
- **XSS 漏洞全面封堵**:
  - 彻底移除 `onclick` 等内联属性中的模板字符串插值，改为基于 `data-*` 属性与事件委托（`safeOnclick`）的安全交互模式，从根源消除 DOM-based XSS 风险。
  - 对所有动态渲染的 HTML 内容（如用户名、题目内容）强制进行 HTML 实体转义。
- **会话管理与主动防御**:
  - **服务端会话销毁**: 新增 `/api/logout` 接口，支持在客户端退出时同步吊销服务端 Token。
  - **异地登录主动断开**: 账号在别处登录时，不仅吊销旧 Token，还会主动断开该用户的 SSE 连接，实现真正的实时下线。
- **权限与越权访问控制**:
  - **敏感数据收紧**: 限制学生访问分组列表、专业分类等管理端接口，遵循最小权限原则。
  - **越权校验加强**: 为试卷详情、考生试卷列表、排行榜等接口增加严格的权属与推送范围校验，防止通过遍历 ID 获取他人数据。
- **输入验证与加固**: 
  - 为所有 API 路由增加输入存在性与合法性基础校验。
  - 优化 CSP (Content Security Policy) 策略，进一步收紧脚本与样式来源限制。

### 🔐 飞书集成与体验优化
- **飞书免登与免确认**:
  - 实现了飞书环境内的静默登录（免登）功能，大幅提升用户进入系统的便捷性。
  - 在登录页飞书图标下方新增实时状态提示（如“正在尝试免登录...”），增强交互透明度。
- **账号单点登录 (SSO) 限制**:
  - **单设备强制下线**: 引入单账号单活动会话限制，新设备登录将自动踢掉旧设备。
  - **实时下线通知**: 集成 SSE 技术，实时感知账号异动。
- **JSSDK 稳定加载**: 修复了飞书 JSSDK 官方链接 ORB 阻断问题，并采用动态按需加载策略，解决非飞书环境下的报错。

### 🛠️ 系统架构与部署升级
- **一键化部署工具 (`run.sh`)**:
  - **Redis & PM2 自动化配置**: 菜单 11 升级为“一键配置 Redis & PM2”，支持自动检测系统环境、安装缺失组件并完成全套配置。
  - **PM2 深度集成**: 脚本现在能自动识别 PM2 环境。若已安装，将优先使用 `ecosystem.config.js` 以集群模式（Cluster Mode）启动服务，并支持 `pm2 save` 实现开机自启。
  - **传统模式兼容**: 在未安装 PM2 的环境下，脚本会自动回退至稳健的 `nohup` 模式，确保服务高可用。
- **会话存储重构**: 重构了 `SessionStore`，新增 `userTokens` 映射表，支持高效的“用户-令牌”吊销检查。
- **统一请求封装**: 增强前端 `authFetch`，支持 401 状态码的统一拦截与会话失效引导。
- **版本一致性控制**: 统一了 `package.json`、`package-lock.json` 与 `/api/version` 接口的版本标识。

## [1.2.0] - 2026-01-23

### 📚 题库设置功能深度增强
- **进阶导入导出**: 支持按“所有题库”或“指定题库”进行区分操作，满足多样化数据迁移需求。
- **权限精细化隔离**: 严格区分操作权限，超管可操作全局题库，组管权限锁定在本组题库范围内。
- **数据安全保障**: 
  - 导入前新增清空原有题库的二次确认机制，彻底规避误操作风险。
  - 导入逻辑支持批量处理，大幅提升大数据量下的导入性能。
- **文件规范化**: 
  - 导出文件名自动遵循“题库名称+导出时间”命名规则。
  - “导出所有”模式下支持自动将所有 Excel 题库打包为 ZIP 压缩包，一键下载。
- **数据校验升级**: 
  - 导出表新增“题库归属”字段（紧随设备类型后），信息更完整。
  - 导入时新增严格的表头校验、基础信息完整性校验及业务数据合法性（题库存在性）校验。

### 🛡️ 试卷管理权属逻辑重构
- **权属标识升级**: 将试卷列表中的“归属分组”重构为“试卷管理员”。
  - 超管创建的试卷标识为“超级管理员”。
  - 组管创建的试卷标识为对应的“分组名称”。
- **管理权限隔离**: 
  - **组管隔离**: 组管现在仅能管理（查看/编辑/推送/删除）由自己亲自创建的试卷，实现了管理颗粒度的垂直细化。
  - **超管全局观**: 超管依然保持对系统中所有试卷的最高管理权限。
- **后端接口加固**: 同步更新所有试卷相关 API，在服务端增加 `creatorId` 级联校验，防止越权操作。

### 🎨 分组及用户设置 UI/UX 优化
- **分组重命名**: 新增超管修改已存在分组名称的功能，提升分组管理灵活性。
- **布局平衡优化**: 
  - **宽度调整**: 将分组管理面板宽度由 300px 提升至 480px，为长名称预留充足空间。
  - **挤压保护**: 引入 `white-space: nowrap` 与 `flex-shrink: 0` 策略，确保分组名称过长时不会挤压操作按钮。
- **操作交互对齐**: PC 端用户管理操作按钮改为左对齐，视觉动线更顺畅，且在按钮动态隐藏时保持布局美观。
- **视觉对比增强**: 优化了管理员（超管/组管）名称在不同主题下的颜色显示，采用系统变量 `var(--primary)` 确保视觉一致性与高对比度。

### 🤖 自动化工作流与通知
- **飞书群通知集成**: 成功接入 GitHub Release 工作流，新版本发布后自动向飞书群推送交互式卡片通知。
- **动态卡片生成**: 通知内容动态抓取 Release 标题与变更日志，实现版本更新信息的实时、精准触达。

## [1.1.0] - 2026-01-22

### 🚀 考试流程与推送逻辑重大升级
- **重复推送支持**: 允许管理员对已完成考试的考生重新推送同一份试卷。
- **成绩保留策略**: 当考生多次参加同一场考试时，系统将自动保留最后一次提交的成绩，确保考核结果的时效性。
- **准入机制优化**: 基于推送时间与提交时间的动态对比，精准控制考生的考试权限。

### 📱 移动端答题界面极致优化
- **布局重构**: 将题号进度移至顶部左侧，剩余时间与累计用时移至顶部右侧，大幅减少垂直空间占用。
- **溢出保护**: 彻底解决了移动端答题卡片内容溢出、Header 高度不协调以及样式冲突问题。
- **交互提升**: 将“继续考试”按钮背景由灰色升级为具有视觉冲击力的橙色渐变（`btn-warning`），并增加悬停动效。

### 🛠️ 管理后台功能增强与 UI 打磨
- **试卷设置模块**: 
  - “创建试卷”更名为“试卷设置”，逻辑更清晰。
  - **编辑功能**: 新增已创建试卷的在线编辑功能，支持实时调整题目配置并同步更新创建时间。
- **手动选题器进化**: 
  - 界面风格与主列表完美统一，支持级联筛选与关键词搜索。
  - **题目预览**: 新增“查看”功能，支持以只读模式快速预览题目详情、选项及标准答案。
- **系统日志优化**:
  - **字段重排**: 调整为“对象-操作-操作者”顺序，更符合操作审计逻辑。
  - **视觉降噪**: 优化了对象字段的背景样式，引入半透明深色设计，提升整体专业感。
  - **一键清空**: 简化日志清理流程，支持一键清空所有历史审计记录。

### 🌐 全局规范化与修复
- **时间格式统一**: 全系统时间显示规范化为 `YYYY-MM-DD HH:mm:ss`。
- **排行榜修复**: 解决了考生界面排行榜列表加载失败的问题，并同步增加了“交卷时间”展示。
- **日志过滤修复**: 修复了“更新试卷”等操作在日志筛选中无法正常显示的 Bug。

### 🛠️ 核心功能修复与编辑器重构
- **题库编辑优化**:
  - **布局升级**: 将题库编辑器（Modal）宽度提升至 1000px，并引入选项双列网格布局，消除冗余垂直滚动。
  - **冲突修复**: 彻底解决了新增与编辑模式下的 DOM ID 冲突，修复了选项重复加载和数据混淆的 Bug。
  - **视觉对齐**: 压缩了表单内边距与垂直间距，使核心编辑区域在一个屏幕高度内完整呈现。

### 🎨 UI/UX 深度打磨
- **移动端体验修复**: 修复了小屏幕下顶部内容被固定 Header 遮挡的问题，并同步更新了所有静态资源的缓存版本号。
- **列表可视化增强**: 题库列表中的“单选、多选、判断”题型现在使用蓝、黄、绿三种不同颜色徽章进行区分，显著提升识别速度。

### 🛡️ 系统稳定性
- **核心 Bug 修复**: 解决了 `db-adapter.js` 中 `dbConfig` 未定义的全局错误。
- **版本同步**: 实现了前后端版本号的精细化同步。

## [1.0.17] - 2026-01-21

### 📱 移动端管理后台 UI 深度重构
- **视觉层级进化**: 建立了“大标题-小副标-中菜单”的专家级字号比例（24px-14px-18px），主次极其分明。
- **品牌感提升**: 将“企业考试系统”设为 24px 白色粗体主标题，极具职业化工具质感。
- **触控标准化**: 统一菜单项为 18px 黄金字号，并将点击热区锁定在 56px 最小高度，显著提升操作容错率。
- **硬件级适配**: 引入 `env(safe-area-inset-top)`，完美避让所有刘海屏与挖孔屏手机的系统状态栏。
- **布局微调**: 
  - 优化了标题与功能区之间的物理隔离间距（30px）。
  - 实现主副标题与下方菜单图标轴线的严格垂直对齐。
  - 压缩底部管理卡片厚度并增加底部悬浮感间距。

### 🛡️ 系统安全性与性能增强
- **密码哈希升级**: 引入 `bcryptjs` 库，替代原有的 SHA256 存储方案，支持更安全的盐值哈希加密。
- **平滑兼容**: 登录逻辑支持自动识别旧版 SHA256 哈希，确保用户升级后无需重置密码。
- **数据库索引优化**: 在 SQLite, MySQL, PostgreSQL 各端同步增加了关键字段（groupId, userId, paperId）的索引，大幅提升大数据量下的查询效率。
- **全局错误屏蔽**: 实现后端异常堆栈的统一过滤，仅对前端返回友好的错误提示，保护后端物理路径、表结构等敏感信息不泄露。
- **日志清理优化**: 修复并整合了日志批量删除接口，提升了系统自我维护的健壮性。

## [1.0.16] - 2026-01-20

### 📱 移动端深度适配与响应式布局升级
- **Tab 栏式导航**: 为移动端引入了全新的底部固定 Tab 导航栏，提供类似原生 App 的操作体验。
- **管理后台适配**: 优化了管理后台在小屏幕下的显示效果，支持侧边栏自动折叠与响应式过滤器布局。
- **UI 组件重构**:
  - 重构了所有按钮和表单项的触摸热区，使其更易于点击。
  - 优化了弹出框（Modal）和提示信息在移动端的定位与宽度。
- **响应式断点**: 增加了多个 CSS 媒体查询断点，确保从折叠屏手机到 iPad 平板电脑都能完美显示。

## [1.0.15] - 2026-01-20

### 🎨 登录界面视觉增强与系统健康优化
- **整体放大**: 显著增大了登录卡片的宽度、字体以及输入框尺寸，使界面更加大气，视觉焦点更集中。
- **响应式优化**: 优化了登录框在不同屏幕尺寸下的自适应表现。
- **版本对齐**: 引入了前后端版本自动化同步机制，确保管理后台显示的系统版本始终与后端物理版本保持一致。
- **间距平衡**: 精确调整了 Logo、表单项与登录按钮之间的间距，提升了整体排版的美感。

## [1.0.14] - 2026-01-20

### 🔄 环境配置管理重大升级 (模板填充法)
- **核心逻辑重构**: 引入全新的“模板填充”机制。系统启动前会以 `.env.example` 为底稿，自动将旧配置项的值精准迁移。
- **配置同步**: 若新版本增加了环境变量（如 `NODE_ENV`），系统将自动将其及默认值以正确的排版补全，不再需要手动干预。
- **服务管理优化**: 修复了 `run.sh` 中 Redis 服务启动时无法识别别名（Alias）导致的红色报错问题。
- **文档修正**: 同步修正了 `README.md` 中关于 Redis 一键配置的菜单项编号（修正为 11）。

## [1.0.13] - 2026-01-20

### 🛠️ 脚本与文档修复
- **服务管理**: 修复了 `run.sh` 中 Redis 服务启动时无法识别别名（Alias）导致的报错问题。
- **文档精确化**:
  - 修正了 `README.md` 中关于一键配置 Redis 的菜单项编号说明（由选项 6 修正为 11）。
  - 同步更新了 `.env.example`，增加了 `NODE_ENV` 变量模板，确保与文档一致。

## [1.0.12] - 2026-01-20

### 🚀 系统优化与安全性
- **高并发支持**: 在 `README.md` 中增加了详细的数据库选型、Redis 会话及连接池优化配置指南。
- **默认账号补完**: 修正了数据库初始化逻辑，现在系统首次启动时会自动创建 `admin` 和 `student` 两个默认账号，且账号可由管理员自行删除。
- **UI/UX 改进**:
  - 删除了登录页面下方的默认账号明文显示，增强隐私安全。
  - 统一了文档、UI 与后端初始化逻辑中的默认用户名（原“张三”统一为 `student`）。
- **Bug 修复**: 修复了 PostgreSQL 初始化脚本中缺失 `VALUES` 关键字的问题。

## [1.0.11] - 2026-01-20

### 🛡️ 安全性与健壮性增强
- **配置校验**:
  - 在 `server.js` 启动时增加 `.env` 文件探测，若缺失则输出黄色警告日志。
  - 在 `run.sh` 启动流程中增加配置文件强制检查。
  - 若 `.env` 缺失但存在 `.env.example`，脚本将自动根据模板创建配置文件，确保环境配置项完整。
  - 防止系统在无配置状态下“静默启动”导致的高并发环境降级风险。

## [1.0.10] - 2026-01-20

### 🐛 问题修复
- **部署脚本**:
  - 修复了系统更新时 `run.sh` 未能同步更新 `.env.example` 文件的问题。
  - 现在执行更新操作将自动刷新 `.env.example`，方便用户参考最新的配置项（如 `USE_REDIS`, `DB_CONNECTION_LIMIT`）。

## [1.0.9] - 2026-01-20

### 🔥 高并发架构优化
- **会话架构 (Session)**:
  - 实现了通用的 `SessionStore` 接口，支持内存和 Redis 两种模式。
  - 引入 `USE_REDIS` 环境变量，支持基于 Redis 的分布式会话管理。
- **数据库性能**:
  - 支持通过 `DB_CONNECTION_LIMIT` 环境变量配置 MySQL/PostgreSQL 的连接池大小。
- **文件上传稳定性**:
  - 将文件上传方式切换为磁盘暂存 (Disk Storage)，防止高并发下内存溢出 (OOM)。
- **进程管理**:
  - 新增 `ecosystem.config.js` 配置文件，支持 PM2 集群模式。

### 🛠️ 系统工具
- **自动配置**:
  - 在 `run.sh` 中新增了 `install_redis` 功能 (菜单选项 11)。
  - 支持在 Linux 上一键安装并配置 Redis。
