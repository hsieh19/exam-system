<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>企业考试系统 - 登录</title>
  <link rel="stylesheet" href="css/style.css?v=3">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>
  <div class="login-container">
    <div class="login-card">
      <div class="login-logo">
        <h1>企业考试系统</h1>
      </div>

      <div id="login-form">
        <div class="form-group">
          <label class="form-label">用户名</label>
          <input type="text" class="form-input" id="username" placeholder="请输入用户名" autocomplete="username"
            autocapitalize="off" autocorrect="off">
        </div>

        <div class="form-group">
          <label class="form-label">密码</label>
          <input type="password" class="form-input" id="password" placeholder="请输入密码" autocomplete="current-password">
        </div>

        <div id="login-error" class="text-danger" style="margin-bottom: 16px; display: none; font-size: 14px;">
          用户名或密码错误
        </div>

        <button type="button" id="login-btn" class="btn btn-primary btn-block" style="margin-top: 40px;">
          登 录
        </button>
      </div>

      <div id="change-password-form" style="display: none;">
        <h2 style="font-size: 18px; margin-bottom: 16px; text-align: center;">首次登录，请修改密码</h2>
        <p style="font-size: 13px; color: var(--text-muted); margin-bottom: 20px; line-height: 1.5;">
          为了您的账户安全，首次登录必须修改密码。新密码必须包含大小写字母、数字和特殊字符，且长度不少于8位。
        </p>
        
        <div class="form-group">
          <label class="form-label">新密码</label>
          <input type="password" class="form-input" id="new-password" placeholder="请输入新密码">
        </div>

        <div class="form-group">
          <label class="form-label">确认新密码</label>
          <input type="password" class="form-input" id="confirm-password" placeholder="请再次输入新密码">
        </div>

        <div id="change-error" class="text-danger" style="margin-bottom: 16px; display: none; font-size: 14px;">
        </div>

        <button type="button" id="change-btn" class="btn btn-primary btn-block" style="margin-top: 24px;">
          确认修改并登录
        </button>
      </div>

      <div style="margin-top: 24px; text-align: center; color: var(--text-muted); font-size: 13px;">
      </div>
    </div>
  </div>

  <script src="js/theme.js"></script>
  <script src="js/storage.js"></script>
  <script src="js/utils.js"></script>
  <script src="js/auth.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      console.log('DOM loaded, initializing login logic...');

      // 检查是否已登录
      try {
        const currentUser = Storage.getCurrentUser();
        if (currentUser) {
          if (currentUser.isFirstLogin) {
            // 如果需要修改密码，显示修改密码表单
            document.getElementById('login-form').style.display = 'none';
            document.getElementById('change-password-form').style.display = 'block';
            // 注意：此时我们没有 _oldPassword，用户可能需要重新登录来获取它，
            // 或者我们可以提示用户重新登录。
            // 为了简单起见，如果从其他页面跳回来且没有 _oldPassword，我们强制用户重新登录
            if (!window._oldPassword) {
              Storage.logout();
              location.reload();
            }
          } else {
            if (currentUser.role === 'admin') {
              window.location.href = 'admin.html';
            } else {
              window.location.href = 'student.html';
            }
          }
          return;
        }
      } catch (e) {
        console.error('Error checking current user:', e);
      }

      const loginBtn = document.getElementById('login-btn');
      if (!loginBtn) {
        console.error('Login button not found!');
        return;
      }

      // 登录按钮点击事件
      loginBtn.addEventListener('click', async function () {
        console.log('Login button clicked');
        // 1. 立即反馈：让用户知道点击被接收了
        const btn = document.getElementById('login-btn');
        const originalText = btn.textContent;
        btn.disabled = true;
        btn.textContent = '正在连接...';

        const username = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value;

        if (!username || !password) {
          document.getElementById('login-error').textContent = '请输入用户名和密码';
          document.getElementById('login-error').style.display = 'block';
          // 恢复按钮
          btn.disabled = false;
          btn.textContent = originalText;
          return;
        }

        try {
          console.log('Calling Auth.login...');
          const result = await Auth.login(username, password);
          console.log('Auth.login result:', result);

          if (result.success) {
            if (result.mustChangePassword) {
              // 显示修改密码表单，隐藏登录表单
              document.getElementById('login-form').style.display = 'none';
              document.getElementById('change-password-form').style.display = 'block';
              // 保存旧密码用于后续修改
              window._oldPassword = password;
            }
          } else {
            document.getElementById('login-error').textContent = '用户名或密码错误';
            document.getElementById('login-error').style.display = 'block';
            // 恢复按钮
            btn.disabled = false;
            btn.textContent = originalText;
          }
        } catch (err) {
          console.error('Login error:', err);
          showAlert('登录发生错误: ' + err.message + '\n请检查服务器是否运行，或按 F12 查看控制台。');
          // 恢复按钮
          btn.disabled = false;
          btn.textContent = originalText;
        }
      });

      // 密码修改按钮点击事件
      const changeBtn = document.getElementById('change-btn');
      if (changeBtn) {
        changeBtn.addEventListener('click', async function () {
          const newPassword = document.getElementById('new-password').value;
          const confirmPassword = document.getElementById('confirm-password').value;
          const errorEl = document.getElementById('change-error');

          if (!newPassword) {
            errorEl.textContent = '请输入新密码';
            errorEl.style.display = 'block';
            return;
          }

          if (newPassword !== confirmPassword) {
            errorEl.textContent = '两次输入的密码不一致';
            errorEl.style.display = 'block';
            return;
          }

          // 强度校验（前端校验，提升体验）
          const hasUpperCase = /[A-Z]/.test(newPassword);
          const hasLowerCase = /[a-z]/.test(newPassword);
          const hasNumber = /[0-9]/.test(newPassword);
          const hasSpecialChar = /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(newPassword);
          
          if (newPassword.length < 8 || !hasUpperCase || !hasLowerCase || !hasNumber || !hasSpecialChar) {
            errorEl.textContent = '密码强度不足：必须包含大小写字母、数字和特殊字符，且不少于8位';
            errorEl.style.display = 'block';
            return;
          }

          try {
            changeBtn.disabled = true;
            changeBtn.textContent = '正在修改...';
            
            await Storage.changePassword(window._oldPassword, newPassword);
            
            // 修改成功，根据角色跳转
            const user = Storage.getCurrentUser();
            if (user.role === 'super_admin' || user.role === 'group_admin') {
              window.location.href = 'admin.html';
            } else {
              window.location.href = 'student.html';
            }
          } catch (err) {
            errorEl.textContent = err.message || '修改密码失败';
            errorEl.style.display = 'block';
            changeBtn.disabled = false;
            changeBtn.textContent = '确认修改并登录';
          }
        });
      }

      // 支持回车键登录
      document.getElementById('password').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
          document.getElementById('login-btn').click();
        }
      });

      console.log('Login logic initialized.');
    });
  </script>
</body>

</html>