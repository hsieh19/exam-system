<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script>
    (function () {
      try {
        var theme = localStorage.getItem('exam-system-theme') || 'dark';
        if (theme !== 'dark') {
          document.documentElement.setAttribute('data-theme', theme);
        }
      } catch (e) { }
    })();
  </script>
  <title>企业考试系统 - 登录</title>
  <link rel="stylesheet" href="css/style.css?v=3">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>
  <div class="login-container" id="main-container" style="opacity: 0; transition: opacity 0.2s ease-in-out;">
    <div class="login-card">
      <div class="login-logo">
        <h1>企业考试系统</h1>
      </div>

      <div id="login-form">
        <div class="form-group">
          <label class="form-label">用户名</label>
          <input type="text" class="form-input" id="username" placeholder="请输入用户名" autocomplete="username"
            autocapitalize="off" autocorrect="off">
        </div>

        <div class="form-group">
          <label class="form-label">密码</label>
          <input type="password" class="form-input" id="password" placeholder="请输入密码" autocomplete="current-password">
        </div>

        <div id="login-error" class="text-danger" style="margin-bottom: 16px; display: none; font-size: 14px;">
          用户名或密码错误
        </div>

        <button type="button" id="login-btn" class="btn btn-primary btn-block" style="margin-top: 40px;">
          登 录
        </button>

        <div id="feishu-login-section" style="margin-top: 32px; text-align: center;">
          <div style="display: flex; align-items: center; margin-bottom: 24px;">
            <div style="flex: 1; height: 1px; background: var(--border);"></div>
            <div style="margin: 0 16px; color: var(--text-muted); font-size: 13px;">其他登录方式</div>
            <div style="flex: 1; height: 1px; background: var(--border);"></div>
          </div>
          <div style="display: flex; justify-content: center;">
            <button type="button" id="feishu-login-btn" class="btn-feishu" title="飞书一键登录">
              <svg width="32" height="32" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" aria-label="飞书" role="img">
                <path d="M8.5611 8.26287L8.59322 8.23075C8.6141 8.20988 8.63658 8.18739 8.65906 8.16652L8.70402 8.12316L8.8373 7.99148L9.02037 7.81324L9.17613 7.65908L9.32226 7.51456L9.47481 7.36361L9.61452 7.22551L9.81043 7.03281C9.84737 6.99588 9.8859 6.96055 9.92444 6.92522C9.9951 6.86099 10.069 6.79836 10.1428 6.73734C10.2119 6.68274 10.2825 6.62975 10.3548 6.57836C10.456 6.5061 10.5603 6.44026 10.6663 6.37603C10.7707 6.31501 10.8783 6.2572 10.9875 6.2026C11.0903 6.15282 11.1963 6.10625 11.3038 6.0645C11.3633 6.04041 11.4243 6.01954 11.4853 5.99866C11.5158 5.98903 11.5463 5.97779 11.5784 5.96815C11.3071 4.90028 10.8109 3.90468 10.122 3.04556C9.98868 2.88016 9.78634 2.78381 9.57438 2.78381H3.94598C3.88817 2.78381 3.84 2.83038 3.84 2.8898C3.84 2.92352 3.85605 2.95403 3.88335 2.97491C5.80391 4.38321 7.39689 6.19297 8.54826 8.27732L8.5611 8.26287Z" fill="#00D6B9"/>
                <path d="M6.32424 13.2168C9.23077 13.2168 11.7631 11.6126 13.0831 9.24238C13.1297 9.15887 13.1747 9.07537 13.218 8.99026C13.1522 9.11712 13.0783 9.23917 12.9964 9.35478C12.9675 9.39493 12.9386 9.43508 12.9081 9.47522C12.8696 9.525 12.831 9.57157 12.7909 9.61814C12.7588 9.65507 12.7266 9.6904 12.6929 9.72573C12.6255 9.79638 12.5548 9.86383 12.4809 9.92646C12.4392 9.96178 12.3991 9.99551 12.3557 10.0276C12.3059 10.0662 12.2545 10.1031 12.2031 10.1368C12.171 10.1593 12.1373 10.1802 12.1036 10.2011C12.0699 10.2219 12.0345 10.2428 11.9976 10.2637C11.9253 10.3038 11.8499 10.3424 11.7744 10.3761C11.7085 10.405 11.6411 10.4323 11.5737 10.458C11.4998 10.4853 11.4259 10.5094 11.3488 10.5302C11.2348 10.5624 11.1208 10.5864 11.0036 10.6041C10.9201 10.617 10.8334 10.6266 10.7483 10.633C10.6583 10.6394 10.5668 10.641 10.4753 10.641C10.3741 10.6394 10.2729 10.633 10.1702 10.6218C10.0947 10.6137 10.0192 10.6025 9.94375 10.5897C9.87791 10.5784 9.81208 10.564 9.74624 10.5479C9.71091 10.5399 9.67719 10.5302 9.64186 10.5206C9.54551 10.4949 9.44916 10.4676 9.35281 10.4403C9.30464 10.4259 9.25646 10.413 9.20989 10.3986C9.13763 10.3777 9.06698 10.3552 8.99632 10.3327C8.93851 10.3151 8.8807 10.2958 8.82289 10.2765C8.76829 10.2589 8.71209 10.2412 8.65749 10.2219L8.54508 10.1834C8.50012 10.1673 8.45355 10.1513 8.40859 10.1352L8.31224 10.0999C8.24801 10.0774 8.18378 10.0533 8.12115 10.0292C8.08421 10.0148 8.04728 10.0019 8.01035 9.98748C7.96057 9.96821 7.91239 9.94894 7.86261 9.92967C7.81123 9.90879 7.75823 9.88792 7.70685 9.86704L7.60568 9.82529L7.48043 9.7739L7.38408 9.73376L7.28452 9.6904L7.1978 9.65186L7.11912 9.61653L7.03883 9.5796L6.95693 9.54106L6.85255 9.49288L6.74336 9.4415C6.70482 9.42223 6.66628 9.40456 6.62774 9.38529L6.52978 9.33712C4.80192 8.4748 3.24267 7.31218 1.92269 5.90227C1.88254 5.86052 1.8167 5.85731 1.77335 5.89746C1.75247 5.91673 1.73962 5.94563 1.73962 5.97454L1.74284 10.9413V11.3444C1.74284 11.5788 1.85845 11.7972 2.05276 11.9273C3.31654 12.772 4.80353 13.22 6.32424 13.2168Z" fill="#3370FF"/>
                <path d="M14.8656 6.21539C13.8844 5.73525 12.7619 5.63248 11.7101 5.92795C11.6652 5.94079 11.6218 5.95364 11.5784 5.96649C11.5479 5.97612 11.5174 5.98576 11.4853 5.997C11.4243 6.01787 11.3633 6.04036 11.3039 6.06284C11.1963 6.10459 11.0919 6.15116 10.9875 6.20094C10.8783 6.25393 10.7707 6.31174 10.6663 6.37276C10.5588 6.43539 10.456 6.50283 10.3548 6.57509C10.2825 6.62648 10.2119 6.67947 10.1428 6.73407C10.0674 6.79509 9.99511 6.85611 9.92445 6.92195C9.88591 6.95728 9.84898 6.99261 9.81044 7.02954L9.61453 7.22224L9.47482 7.36034L9.32227 7.51129L9.17614 7.65581L9.02038 7.80997L8.83892 7.98982L8.70564 8.1215L8.66067 8.16485C8.6398 8.18573 8.61732 8.20821 8.59483 8.22909L8.56272 8.2612L8.51294 8.30777C8.49367 8.32544 8.476 8.34149 8.45673 8.35916C7.97338 8.80397 7.43383 9.18455 6.85413 9.49447L6.9585 9.54265L7.0404 9.58119L7.12069 9.61812L7.19938 9.65345L7.28609 9.69199L7.38565 9.73534L7.482 9.77549L7.60725 9.82688L7.70842 9.86863C7.75981 9.8895 7.8128 9.91038 7.86419 9.93125C7.91236 9.95052 7.96214 9.9698 8.01192 9.98907C8.04886 10.0035 8.08579 10.0164 8.12272 10.0308C8.18696 10.0549 8.25119 10.0774 8.31382 10.1015L8.41016 10.1368C8.45513 10.1529 8.50009 10.1689 8.54666 10.185L8.65907 10.2235C8.71366 10.2412 8.76826 10.2604 8.82447 10.2781C8.88228 10.2974 8.94008 10.315 8.99789 10.3343C9.06855 10.3568 9.14081 10.3777 9.21147 10.4002C9.25964 10.4146 9.30782 10.4291 9.35439 10.4419C9.45073 10.4692 9.54708 10.4965 9.64343 10.5222C9.67876 10.5318 9.71248 10.5399 9.74781 10.5495C9.81365 10.5656 9.87949 10.5784 9.94533 10.5912C10.0208 10.6041 10.0963 10.6153 10.1717 10.6234C10.2745 10.6346 10.3757 10.641 10.4769 10.6426C10.5684 10.6442 10.6599 10.641 10.7498 10.6346C10.8366 10.6282 10.9217 10.6185 11.0052 10.6057C11.1208 10.588 11.2364 10.5623 11.3504 10.5318C11.4259 10.511 11.5014 10.4869 11.5752 10.4596C11.6427 10.4355 11.7101 10.4082 11.776 10.3777C11.8514 10.344 11.9269 10.3054 11.9992 10.2653C12.0345 10.246 12.0698 10.2251 12.1052 10.2026C12.1405 10.1818 12.1726 10.1593 12.2047 10.1384C12.2561 10.1031 12.3075 10.0677 12.3573 10.0292C12.4006 9.99709 12.4424 9.96337 12.4825 9.92804C12.55487 9.65666 12.7908 9.61973 12.831 9.57316 12.8711 9.52498 12.9081 9.47681 12.9386 9.43827 12.9675 9.39812 12.9964 9.35637 13.0767 9.24075 13.1505 9.12032 13.2164 8.99506L13.2919 8.84572L13.9631 7.50807L13.9711 7.49202C14.1927 7.01348 14.4946 6.58312 14.8656 6.21539Z" fill="#133C9A"/>
              </svg>
            </button>
          </div>
        </div>
      </div>

      <div id="change-password-form" style="display: none;">
        <h2 style="font-size: 18px; margin-bottom: 16px; text-align: center;">首次登录，请修改密码</h2>
        <p style="font-size: 13px; color: var(--text-muted); margin-bottom: 20px; line-height: 1.5;">
          为了您的账户安全，首次登录必须修改密码。新密码必须包含大小写字母、数字和特殊字符，且长度不少于8位。
        </p>
        
        <div class="form-group">
          <label class="form-label">新密码</label>
          <input type="password" class="form-input" id="new-password" placeholder="请输入新密码">
        </div>

        <div class="form-group">
          <label class="form-label">确认新密码</label>
          <input type="password" class="form-input" id="confirm-password" placeholder="请再次输入新密码">
        </div>

        <div id="change-error" class="text-danger" style="margin-bottom: 16px; display: none; font-size: 14px;">
        </div>

        <button type="button" id="change-btn" class="btn btn-primary btn-block" style="margin-top: 24px;">
          确认修改并登录
        </button>
      </div>

      <div style="margin-top: 24px; text-align: center; color: var(--text-muted); font-size: 13px;">
      </div>
    </div>
  </div>

  <script src="js/theme.js"></script>
  <script src="js/storage.js"></script>
  <script src="js/utils.js"></script>
  <script src="js/auth.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const container = document.getElementById('main-container');

      // 1. 立即检查是否已登录，优先重定向，避免显示登录界面
      try {
        const currentUser = Storage.getCurrentUser();
        if (currentUser) {
          if (currentUser.isFirstLogin) {
            // 如果需要修改密码，显示修改密码表单
            if (container) container.style.opacity = '1';
            document.getElementById('login-form').style.display = 'none';
            document.getElementById('change-password-form').style.display = 'block';
            if (!window._oldPassword) {
              Storage.logout();
              location.reload();
            }
          } else {
            if (currentUser.role === 'super_admin' || currentUser.role === 'group_admin') {
              window.location.href = 'admin.html';
            } else {
              window.location.href = 'student.html';
            }
          }
          return;
        }
      } catch (e) {
        console.error('Initial session check failed:', e);
      }

      // 2. 未登录，显示界面并继续初始化
      if (container) container.style.opacity = '1';
      console.log('DOM loaded, initializing login logic...');
      
      try {
        const reason = SafeStorage.get('logout_reason');
        if (reason) {
          SafeStorage.remove('logout_reason');
          showAlert(reason);
        }
      } catch (e) { }

      // 飞书集成逻辑
      async function initFeishuLogin() {
        const feishuBtn = document.getElementById('feishu-login-btn');
        const feishuSection = document.getElementById('feishu-login-section');
        
        // 1. 获取飞书配置
        let feishuConfig = null;
        try {
          feishuConfig = await Storage.getFeishuConfig();
        } catch (e) {
          console.error('Failed to get Feishu config', e);
          if (feishuSection) feishuSection.style.display = 'none';
          return;
        }

        if (!feishuConfig || !feishuConfig.appId) {
          if (feishuSection) feishuSection.style.display = 'none';
          return;
        }

        const getStatusEl = () => {
          if (!feishuSection) return null;
          let el = document.getElementById('feishu-login-status');
          if (el) return el;
          el = document.createElement('div');
          el.id = 'feishu-login-status';
          el.style.cssText = 'margin-top: 10px; font-size: 12px; color: var(--text-muted); line-height: 1.4;';
          feishuSection.appendChild(el);
          return el;
        };
        const setStatus = (text) => {
          const el = getStatusEl();
          if (!el) return;
          el.textContent = text || '';
          el.style.display = text ? 'block' : 'none';
        };

        const loadSdk = () => new Promise((resolve, reject) => {
          if (window.h5sdk) return resolve();
          const script = document.createElement('script');
          script.src = 'https://lf1-cdn-tos.bytegoofy.com/goofy/lark/op/h5-js-sdk-1.5.23.js';
          script.onload = () => resolve();
          script.onerror = () => reject(new Error('无法加载飞书 SDK，请检查网络连接'));
          document.head.appendChild(script);
        });

        const isFeishuUA = /Lark|Feishu|LarkWebView|FeishuWebView/i.test(navigator.userAgent);
        
        const waitSdkReady = () => new Promise((resolve) => {
          try {
            if (window.h5sdk && typeof window.h5sdk.ready === 'function') {
              window.h5sdk.ready(() => resolve());
              return;
            }
          } catch (_) { }
          resolve();
        });
        const getAuthApi = () => {
          const candidates = [
            window.tt,
            window.lark,
            window.feishu,
            window.h5sdk && window.h5sdk.tt
          ].filter(Boolean);
          return candidates.find(api => api && typeof api.requestAuthCode === 'function') || null;
        };

        const requestAuthCode = (timeoutMs = 8000) => new Promise((resolve, reject) => {
          const start = Date.now();
          let done = false;
          const finish = (fn) => {
            if (done) return;
            done = true;
            fn();
          };

          const tryCall = () => {
            const api = getAuthApi();
            if (api && typeof api.requestAuthCode === 'function') {
              try {
                api.requestAuthCode({
                  appId: feishuConfig.appId,
                  success: (res) => finish(() => resolve(res && res.code)),
                  fail: (err) => finish(() => reject(new Error(typeof err === 'string' ? err : JSON.stringify(err))))
                });
              } catch (e) {
                finish(() => reject(e));
              }
              return;
            }

            if (Date.now() - start >= timeoutMs) {
              finish(() => reject(new Error('飞书 JSSDK 未就绪（requestAuthCode 不可用）')));
              return;
            }
            setTimeout(tryCall, 50);
          };

          try {
            if (window.h5sdk && typeof window.h5sdk.ready === 'function') {
              window.h5sdk.ready(() => tryCall());
            } else {
              tryCall();
            }
          } catch (e) {
            reject(e);
          }
        });
        
        const handleFeishuLogin = async (code) => {
          try {
            if (feishuBtn) {
              feishuBtn.disabled = true;
              feishuBtn.classList.add('loading');
            }
            await Auth.feishuLogin(code);
          } catch (err) {
            console.error('Feishu login failed', err);
            showAlert('飞书登录失败: ' + err.message);
            if (feishuBtn) {
              feishuBtn.disabled = false;
              feishuBtn.classList.remove('loading');
            }
          }
        };

        // 3. 检查 URL 中是否有 code (用于非静默登录回调)
        const urlParams = new URLSearchParams(window.location.search);
        const urlCode = urlParams.get('code');
        if (urlCode) {
          console.log('Detected code in URL, attempting login...');
          const newUrl = window.location.origin + window.location.pathname;
          window.history.replaceState({}, document.title, newUrl);
          handleFeishuLogin(urlCode);
          return;
        }

        // 4. 如果在飞书内，尝试免登
        if (isFeishuUA) {
          try {
            setStatus('飞书免登录：初始化中…');
            await loadSdk();
            await waitSdkReady();
            console.log('Detect Feishu environment, attempting silent login...');
            setStatus('飞书免登录：正在尝试…');
            const code = await requestAuthCode(8000);
            if (code) {
              setStatus('');
              console.log('Got Feishu auth code silently');
              handleFeishuLogin(code);
            } else {
              setStatus('飞书免登录：未获取到授权码，请点击飞书图标重试');
            }
          } catch (err) {
            console.error('Feishu silent auth failed', err);
            const msg = err && err.message ? err.message : String(err);
            if (/未就绪|requestAuthCode/i.test(msg)) {
              setStatus('飞书免登录：授权组件未就绪，请点击飞书图标重试');
            } else {
              setStatus('飞书免登录失败：' + msg);
            }
          }
        }

        // 5. 绑定按钮点击事件
        if (feishuBtn) {
          feishuBtn.addEventListener('click', async () => {
            try {
              setStatus('正在初始化飞书组件…');
              await loadSdk();
              if (isFeishuUA) {
                setStatus('正在获取飞书授权码…');
                await waitSdkReady();
                const code = await requestAuthCode(8000);
                setStatus('');
                handleFeishuLogin(code);
              } else {
                setStatus('');
                const redirectUri = encodeURIComponent(feishuConfig.redirectUri || window.location.href);
                const appId = feishuConfig.appId;
                window.location.href = `https://open.feishu.cn/open-apis/authen/v1/index?app_id=${appId}&redirect_uri=${redirectUri}`;
              }
            } catch (err) {
              setStatus('');
              showAlert('获取飞书授权码失败: ' + (err && err.message ? err.message : String(err)));
            }
          });
        }
      }

      initFeishuLogin();

      const loginBtn = document.getElementById('login-btn');
      if (!loginBtn) {
        console.error('Login button not found!');
        return;
      }

      // 登录按钮点击事件
      loginBtn.addEventListener('click', async function () {
        console.log('Login button clicked');
        // 1. 立即反馈：让用户知道点击被接收了
        const btn = document.getElementById('login-btn');
        const originalText = btn.textContent;
        btn.disabled = true;
        btn.textContent = '正在连接...';

        const username = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value;

        if (!username || !password) {
          document.getElementById('login-error').textContent = '请输入用户名和密码';
          document.getElementById('login-error').style.display = 'block';
          // 恢复按钮
          btn.disabled = false;
          btn.textContent = originalText;
          return;
        }

        try {
          console.log('Calling Auth.login...');
          const result = await Auth.login(username, password);
          console.log('Auth.login result:', result);

          if (result.success) {
            if (result.mustChangePassword) {
              // 显示修改密码表单，隐藏登录表单
              document.getElementById('login-form').style.display = 'none';
              document.getElementById('change-password-form').style.display = 'block';
              // 保存旧密码用于后续修改
              window._oldPassword = password;
            }
          } else {
            document.getElementById('login-error').textContent = '用户名或密码错误';
            document.getElementById('login-error').style.display = 'block';
            // 恢复按钮
            btn.disabled = false;
            btn.textContent = originalText;
          }
        } catch (err) {
          console.error('Login error:', err);
          showAlert('登录发生错误: ' + err.message + '\n请检查服务器是否运行，或按 F12 查看控制台。');
          // 恢复按钮
          btn.disabled = false;
          btn.textContent = originalText;
        }
      });

      // 密码修改按钮点击事件
      const changeBtn = document.getElementById('change-btn');
      if (changeBtn) {
        changeBtn.addEventListener('click', async function () {
          const newPassword = document.getElementById('new-password').value;
          const confirmPassword = document.getElementById('confirm-password').value;
          const errorEl = document.getElementById('change-error');

          if (!newPassword) {
            errorEl.textContent = '请输入新密码';
            errorEl.style.display = 'block';
            return;
          }

          if (newPassword !== confirmPassword) {
            errorEl.textContent = '两次输入的密码不一致';
            errorEl.style.display = 'block';
            return;
          }

          // 强度校验（前端校验，提升体验）
          const hasUpperCase = /[A-Z]/.test(newPassword);
          const hasLowerCase = /[a-z]/.test(newPassword);
          const hasNumber = /[0-9]/.test(newPassword);
          const hasSpecialChar = /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(newPassword);
          
          if (newPassword.length < 8 || !hasUpperCase || !hasLowerCase || !hasNumber || !hasSpecialChar) {
            errorEl.textContent = '密码强度不足：必须包含大小写字母、数字和特殊字符，且不少于8位';
            errorEl.style.display = 'block';
            return;
          }

          try {
            changeBtn.disabled = true;
            changeBtn.textContent = '正在修改...';
            
            await Storage.changePassword(window._oldPassword, newPassword);
            
            // 修改成功，根据角色跳转
            const user = Storage.getCurrentUser();
            if (user.role === 'super_admin' || user.role === 'group_admin') {
              window.location.href = 'admin.html';
            } else {
              window.location.href = 'student.html';
            }
          } catch (err) {
            errorEl.textContent = err.message || '修改密码失败';
            errorEl.style.display = 'block';
            changeBtn.disabled = false;
            changeBtn.textContent = '确认修改并登录';
          }
        });
      }

      // 支持回车键登录
      document.getElementById('password').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
          document.getElementById('login-btn').click();
        }
      });

      console.log('Login logic initialized.');
    });
  </script>
</body>

</html>
